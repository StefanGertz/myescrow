<!-- --- PART 1 / 3 (HEAD + STYLES) --- -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>
      MyEscrow - Interactive Wireframe Demo
    </title>
<style>
:root {
  --brand:#0f4c81;
  --brand-600:#0c3458;
  --brand-400:#3a86c5;
  --muted:#6b7280;
  --card:#ffffff;
  --surface:#f4f6f9;
  --accent-orange:#f59e0b;
  --accent-magenta:#5b21b6;
  --accent-cyan:#14b8a6;
  --radius:14px;
  --shadow-soft:0 14px 38px rgba(15,76,129,0.12);
}

html, body {
  height:100%;
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background:linear-gradient(180deg,#f6f8fb,#e5ebf2);
  color:#0f172a;
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
}

body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  background-attachment:fixed;
}

.app {
  min-height:100%;
  display:grid;
  grid-template-rows:auto 1fr auto;
  opacity:1;
}

.app.visible {
  opacity:1;
}

header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  background:linear-gradient(120deg,#0f1f3d,#0f4c81);
  color:#fff;
  position:sticky;
  top:0;
  z-index:10;
  box-shadow:0 8px 24px rgba(7,14,29,0.35);
}

main {
  position:relative;
  min-height:0;
}

.brand {
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
}

.logo-mark {
  width:36px;
  height:36px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(145deg,var(--brand-600),var(--brand));
  box-shadow:0 8px 16px rgba(12,29,45,0.2);
  font-size:18px;
  position:relative;
}

.header-actions {
  display:flex;
  gap:8px;
  align-items:center;
}

.icon-btn {
  background:rgba(255,255,255,0.22);
  color:#fff;
  border:0;
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer;
  transition:background .2s ease;
  position:relative;
}

.icon-btn:hover {
  background:rgba(255,255,255,0.32);
}

.icon-btn[data-has-notif="true"]::after {
  content:'';
  position:absolute;
  top:6px;
  right:6px;
  width:8px;
  height:8px;
  border-radius:50%;
  background:#ff5c5c;
  box-shadow:0 0 0 3px rgba(255,92,92,0.25);
}

.screen {
  position:absolute;
  inset:0;
  overflow:auto;
  padding:16px;
  display:none;
  animation:fadeIn .5s ease both;
}

.screen.active {
  display:block;
}

h2 {
  font-size:21px;
  margin:0 0 8px;
}

.lead {
  color:var(--muted);
  margin:0 0 14px;
}

.tiles {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:12px;
  margin-bottom:12px;
}

.tile,
.card {
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow-soft);
  border:1px solid rgba(15,76,129,0.12);
  backdrop-filter:blur(6px);
}

.tile {
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:8px;
  min-height:130px;
}

.tile .t-title {
  font-size:17px;
  font-weight:700;
  color:var(--brand-600);
  letter-spacing:0.1px;
}

.tile .muted {
  margin:0;
  line-height:1.45;
}

.tile button {
  margin-top:auto;
}

.warning-text {
  color:#dc2626;
  font-weight:600;
}

.home-stack {
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:12px;
}

.flow-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:12px;
  margin-top:12px;
}

.flow-block {
  border:1px dashed rgba(15,76,129,0.25);
  border-radius:12px;
  padding:12px;
  background:rgba(255,255,255,0.88);
  box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
}

.flow-pill {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(20,184,166,0.14);
  color:var(--brand-600);
  font-size:13px;
  font-weight:600;
}

.flow-steps {
  margin:10px 0 0;
  padding-left:18px;
  color:#1f1f3d;
  font-size:14px;
  line-height:1.45;
  list-style:decimal;
  list-style-position:outside;
}

.alert-card {
  border-left:4px solid var(--accent-orange);
  position:relative;
}

.alert-pill {
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(255,156,71,0.15);
  color:var(--accent-orange);
  padding:4px 12px;
  border-radius:999px;
  font-weight:700;
  font-size:13px;
}

.alert-head {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  margin-top:8px;
}

.process-steps {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-top:12px;
}

.process-step {
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(15,76,129,0.16);
  background:rgba(255,255,255,0.94);
  position:relative;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.process-step::before {
  content:'';
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--muted);
  position:absolute;
  top:12px;
  right:12px;
}

.process-step[data-status="complete"] {
  border-color:#22c55e;
}

.process-step[data-status="complete"]::before {
  background:#22c55e;
}

.process-step[data-status="active"] {
  border-color:var(--brand);
  box-shadow:0 0 0 1px rgba(15,76,129,0.14);
}

.process-step[data-status="active"]::before {
  background:var(--brand);
}

.process-step[data-status="upcoming"] {
  opacity:0.75;
}

.process-step-title {
  font-weight:700;
}

.process-step-detail {
  font-size:13px;
  color:#4c4f6b;
}

.process-step-status {
  font-size:12px;
  font-weight:600;
  color:var(--brand-600);
}

.notif-list {
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:12px;
}

.notif-item {
  border:1px solid rgba(15,76,129,0.16);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:4px;
  text-align:left;
  background:#fff;
  cursor:pointer;
  transition:box-shadow .2s ease, border-color .2s ease;
}

.notif-item:hover {
  border-color:var(--brand);
  box-shadow:0 8px 18px rgba(15,23,42,0.12);
}

.notif-item[data-disabled="true"] {
  cursor:default;
  opacity:0.8;
}

.notif-item[data-disabled="true"]:hover {
  border-color:rgba(15,76,129,0.16);
  box-shadow:none;
}

.notif-title {
  font-weight:700;
  display:flex;
  align-items:center;
  gap:6px;
}

.notif-detail {
  font-size:13px;
  color:#4c4f6b;
}

.notif-meta {
  font-size:12px;
  color:var(--muted);
}

.notif-badge {
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.04em;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(20,184,166,0.14);
  color:var(--brand-600);
}

.flow-steps li {
  margin-bottom:6px;
}

.form-field {
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:14px;
}

.form-field .muted {
  margin:0;
  font-weight:600;
  color:var(--brand-400);
}

.milestone-form {
  display:grid;
  grid-template-columns:1fr minmax(120px, 160px) auto;
  gap:8px;
  align-items:end;
}

.milestone-form .form-field {
  margin-bottom:0;
}

.milestone-form button {
  height:44px;
}

@media (max-width: 560px) {
  .milestone-form {
    grid-template-columns:1fr;
  }

  .milestone-form button {
    width:100%;
  }
}

input[type="text"],
input[type="email"],
input[type="number"],
input[type="tel"],
input[type="password"],
input[type="url"],
input[type="search"],
textarea,
select {
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(15,76,129,0.18);
  background-color:rgba(255,255,255,0.98);
  background-image:none;
  color:#1f1f3d;
  font-family:inherit;
  font-size:15px;
  box-sizing:border-box;
  box-shadow:0 10px 22px rgba(15,76,129,0.08);
  transition:border-color .2s ease, box-shadow .2s ease, transform .2s ease;
}

#create-category {
  padding-right:38px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%230f4c81' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 16px center;
  background-size:14px 14px;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="number"]:focus,
input[type="tel"]:focus,
input[type="password"]:focus,
input[type="url"]:focus,
input[type="search"]:focus,
textarea:focus,
select:focus {
  outline:none;
  border-color:var(--brand-400);
  box-shadow:0 0 0 2px rgba(15,76,129,0.2), 0 14px 28px rgba(15,76,129,0.18);
  transform:translateY(-1px);
}

.milestone-form input[type="text"],
.milestone-form input[type="number"] {
  width:100%;
  margin-bottom:0;
}

input::placeholder,
textarea::placeholder {
  color:rgba(15,23,42,0.45);
}

.milestone-form input[type="number"]::-webkit-outer-spin-button,
.milestone-form input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance:none;
  margin:0;
}

input[type="number"] {
  -moz-appearance:textfield;
}

.tx-list {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.tx-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:12px;
  background:rgba(255,255,255,0.96);
  border:1px solid rgba(15,76,129,0.12);
  box-shadow:0 8px 18px rgba(15,76,129,0.08);
}

.tx-item.selected {
  border-color:rgba(15,76,129,0.35);
  box-shadow:0 0 0 2px rgba(20,184,166,0.18);
}

.role-toggle {
  display:flex;
  gap:10px;
  margin:10px 0 14px;
  flex-wrap:wrap;
}

.role-option {
  flex:1 1 130px;
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:center;
  padding:10px 12px;
  border:1px solid rgba(15,76,129,0.2);
  border-radius:12px;
  background:rgba(255,255,255,0.96);
  font-weight:600;
  color:#1f1f3d;
  cursor:pointer;
  transition:all .2s ease;
  box-shadow:0 10px 22px rgba(15,76,129,0.08);
}

.role-option.active {
  border-color:var(--brand);
  background:linear-gradient(140deg,rgba(15,76,129,0.14),rgba(20,184,166,0.12));
  color:var(--brand);
  box-shadow:0 12px 28px rgba(15,76,129,0.2);
}

.role-option input {
  margin:0;
  accent-color:var(--brand);
}

.role-option span {
  flex:1;
  text-align:center;
}

.btn {
  background:linear-gradient(120deg,var(--brand-600),var(--brand));
  color:#fff;
  border:0;
  padding:10px 14px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 10px 22px rgba(15,76,129,0.26);
  transition:transform .2s ease, box-shadow .2s ease;
}

.btn:hover {
  transform:translateY(-1px);
  box-shadow:0 14px 26px rgba(15,76,129,0.3);
}

.ghost {
  background:rgba(255,255,255,0.92);
  border:1px solid rgba(15,76,129,0.16);
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
  color:var(--brand);
  font-weight:600;
  transition:background .2s ease,border .2s ease;
}

.ghost:hover {
  background:rgba(255,255,255,1);
  border-color:rgba(15,76,129,0.3);
}

.toolbar {
  display:flex;
  justify-content:center;
  align-items:center;
  padding:8px 0 calc(env(safe-area-inset-bottom) + 8px);
}

.bottom-nav {
  background:rgba(10,24,40,0.9);
  border-radius:999px;
  padding:6px;
  display:flex;
  gap:6px;
  box-shadow:0 18px 36px rgba(6,14,24,0.4);
}

.bottom-nav button {
  background:transparent;
  border:0;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  color:#8593a8;
  transition:background .2s ease,color .2s ease;
  font-size:0;
}

.bottom-nav button.active {
  background:linear-gradient(90deg,var(--brand-600),var(--brand));
  color:#fff;
}

.status-badge {
  display:inline-block;
  padding:2px 8px;
  border-radius:10px;
  font-size:12px;
  font-weight:600;
  color:#fff;
  text-transform:capitalize;
}

.status-pending{background:var(--accent-orange);}
.status-active{background:var(--brand);}
.status-resolved{background:#22c55e;}
.status-disputed{background:#f87171;}
.status-released{background:#0d9488;}

.sig-wrap {
  background:rgba(255,255,255,0.92);
  border-radius:12px;
  padding:10px;
  border:1px solid rgba(15,76,129,0.16);
  box-shadow:0 8px 20px rgba(15,76,129,0.08);
}

canvas.signature {
  width:100%;
  height:140px;
  background:#fff;
  border-radius:10px;
  touch-action:none;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

@keyframes splashFade {
  0% { opacity:0; transform:translate3d(0,8px,0); }
  30% { opacity:1; transform:translate3d(0,0,0); }
  70% { opacity:1; }
  100% { opacity:0; }
}

.s-pulse {
  animation:sp 2.6s ease-in-out infinite;
}

@keyframes sp {
  0%, 100% { transform:scale(1); }
  50% { transform:scale(1.06); }
}

.setting-card + .setting-card {
  margin-top:18px;
}

.setting-card {
  background:linear-gradient(150deg,rgba(15,76,129,0.12),rgba(20,184,166,0.08));
  border:1px solid rgba(15,76,129,0.18);
  box-shadow:0 18px 38px rgba(15,76,129,0.12);
}

#s-settings .card {
  margin-bottom:18px;
}

#s-settings .card:last-of-type {
  margin-bottom:0;
}

.settings-form {
  display:flex;
  flex-direction:column;
  gap:12px;
}

.settings-form label {
  font-weight:600;
  color:var(--brand-400);
}

.settings-actions {
  display:flex;
  gap:10px;
  justify-content:flex-end;
  margin-top:16px;
}

.logo-mark svg {
  display:none !important;
}

.logo-mark::after {
  content:"";
  position:absolute;
  inset:0;
  margin:auto;
  width:20px;
  height:20px;
  background:linear-gradient(140deg,#ffffff,#eef0ff);
  -webkit-mask-repeat:no-repeat;
  -webkit-mask-position:center;
  -webkit-mask-size:contain;
  mask-repeat:no-repeat;
  mask-position:center;
  mask-size:contain;
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 2l7 3v6c0 5-3.5 9.5-7 11-3.5-1.5-7-6-7-11V5l7-3zm-1 12l5-5-1.4-1.4L11 10.2 9.4 8.6 8 10l3 4z' fill='black'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 2l7 3v6c0 5-3.5 9.5-7 11-3.5-1.5-7-6-7-11V5l7-3zm-1 12l5-5-1.4-1.4L11 10.2 9.4 8.6 8 10l3 4z' fill='black'/></svg>");
}

#homeTop::before,
#notifTop::before,
#profileTop::before,
#bn-dashboard::before,
#bn-create::before,
#bn-wallet::before,
#bn-settings::before {
  content:"";
  display:block;
  width:20px;
  height:20px;
  background:currentColor;
  -webkit-mask-repeat:no-repeat;
  -webkit-mask-position:center;
  -webkit-mask-size:contain;
  mask-repeat:no-repeat;
  mask-position:center;
  mask-size:contain;
}

#homeTop::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 10.5L12 3l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9.5z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 10.5L12 3l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9 v6H4a1 1 0 0 1-1-1v-9.5z'/></svg>");
}

#notifTop::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm6-6v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2zm6-6v-5a6 6 0 1 0-12 0v5l-2 2h16l-2-2z'/></svg>");
}

#profileTop::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z'/></svg>");
}

#bn-dashboard::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z'/></svg>");
}

#bn-create::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6V5z'/></svg>");
}

#bn-wallet::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 7a2 2 0 0 1 2-2h13a3 3 0 0 1 3 3v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7zm12 3h6v4h-6a2 2 0 0 1 0-4z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M3 7a2 2 0 0 1 2-2h13a3 3 0 0 1 3 3v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7zm12 3h6v4h-6a2 2 0 0 1 0-4z'/></svg>");
}

#bn-settings::before {
  -webkit-mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M4 6h16v2H4V6zm3 5h10v2H7v-2zm-5 5h16v2H2v-2z'/></svg>");
  mask-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M4 6h16v2H4V6zm3 5h10v2H7v-2zm-5 5h16v2H2v-2z'/></svg>");
}

#iab-open-safari {
  position:fixed;
  right:12px;
  bottom:calc(env(safe-area-inset-bottom) + 74px);
  background:linear-gradient(120deg,#0f1f3d,#0f4c81);
  color:#fff;
  border:0;
  padding:8px 12px;
  border-radius:999px;
  box-shadow:0 10px 24px rgba(12,52,88,0.25);
  z-index:95;
  display:none;
  font-size:14px;
}
</style>
</head>
<body>
  <noscript>
    <div style="position:fixed;inset:0;background:#0b1220;color:#fff;display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;text-align:center;">
      <div style="max-width:520px;line-height:1.45;">
        <div style="font-weight:800;font-size:20px;margin-bottom:8px;">
          JavaScript Required
        </div>
        <div>
          This interactive demo needs JavaScript. If you opened it inside an app (e.g., WhatsApp or Mail), tap the share icon and choose "Open in Safari".
        </div>
      </div>
    </div>
  </noscript>
  <!-- -PART 2 / 3 — BODY + SCREENS + TOOLBAR- -->
  <!-- Splash (animated logo) -->
  <div id="splash" style="position:fixed;inset:0;background:linear-gradient(135deg,#0f1f3d,#0f4c81);display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;z-index:9999;animation:splashFade 1.6s ease forwards;pointer-events:none;">
<svg class="s-pulse" viewBox="0 0 24 24" width="84" height="84" aria-hidden="true">
  <path d="M4 13a4 4 0 0 1 4-4h4l3-3 5 5-3 3v2a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4z" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
<div style="height:12px;">
</div>
<div style="font-weight:800;font-size:22px;">
  MyEscrow
</div>
</div>
<div class="app" id="app">
  <header>
    <div class="brand" id="brand" role="button" title="Home">
      <div class="logo-mark" aria-hidden="true">
      </div>
      <div class="brand-text">
        MyEscrow
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="homeTop" aria-label="Home">
        .
      </button>
      <button class="icon-btn" id="notifTop" aria-label="Notifications">
        .
      </button>
      <button class="icon-btn" id="profileTop" aria-label="Profile">
        .
      </button>
    </div>
  </header>
  <main id="main">
    <!-- Home / Welcome -->
    <section id="s-welcome" class="screen active">
      <h2>
        Welcome back,
        <span id="welcome-name">
          Scott
        </span>
      </h2>
      <p class="lead">
        The micro-escrow for everyday transactions
      </p>
      <div class="tiles">
        <div class="tile">
          <div class="t-title">
            Wallet
          </div>
          <div class="muted">
            Balance
          </div>
          <div style="font-weight:800;font-size:18px;">
            $
            <span id="ui-balance">
              0.00
            </span>
          </div>
          <button class="ghost" data-action="navigate" data-target="s-wallet">
            Manage
          </button>
        </div>
        <div class="tile">
          <div class="t-title">
            Create
          </div>
          <div class="muted">
            New escrow
          </div>
          <button class="btn" data-action="navigate" data-target="s-create">
            Create
          </button>
        </div>
        <div class="tile">
          <div class="t-title">
            Recent
          </div>
          <div class="muted">
            Last activity
          </div>
          <div id="ui-recent" class="muted">
            No activity yet
          </div>
        </div>
        <div class="tile">
          <div class="t-title">
            Active
          </div>
          <div class="muted">
            Ongoing escrows
          </div>
          <button class="ghost" data-action="navigate" data-target="s-active-escrows">
            View
          </button>
        </div>
        <div class="tile">
          <div class="t-title">
            Support
          </div>
          <div class="muted">
            Help &amp; docs
          </div>
          <button class="ghost" data-action="modal" data-content="<h3>
            Support
          </h3>
          <p class='muted'>
            For demo support, reach out to the team.
          </p>
          ">Contact
          </button>
        </div>
      <div class="tile">
        <div class="t-title">
          Escrow history
        </div>
        <div class="muted">
          Past escrows
        </div>
      <button class="ghost" data-action="navigate" data-target="s-history">
        View history
      </button>
    </div>
  </div>
    <div class="home-stack">
      <div class="card alert-card" id="home-pending-card" style="display:none;">
        <div class="alert-pill" id="home-pending-pill">
          Pending action
        </div>
        <div class="alert-head">
          <div>
            <div class="muted" id="home-pending-context">
              New escrow
            </div>
            <div style="font-size:18px;font-weight:700;" id="home-pending-title">
            </div>
            <div class="muted" id="home-pending-desc" style="margin-top:4px;">
            </div>
          </div>
          <button class="ghost" id="home-pending-view">
            View escrow
          </button>
        </div>
        <div class="process-steps" id="home-pending-steps">
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:8px">
          Recent transactions
        </h3>
        <div id="tx-list" class="tx-list">
        </div>
      </div>
    </div>
  </section>
  <!-- Active Escrows -->
  <section id="s-active-escrows" class="screen">
    <h2>
      Active escrows
    </h2>
    <p class="lead">
      Escrows that are currently funded or awaiting completion.
    </p>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>
          Current escrows
        </strong>
        <button class="ghost" data-action="navigate" data-target="s-create">
          New escrow
        </button>
      </div>
      <div id="active-escrows-list" class="tx-list" style="margin-top:12px;">
      </div>
      <div id="active-escrows-empty" class="muted" style="margin-top:8px;display:none;">
        No active escrows right now.
      </div>
    </div>
    <div id="active-escrow-detail" class="card" style="margin-top:12px;display:none;">
      <div id="active-escrow-meta" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;">
      </div>
      <div id="active-escrow-progress" class="muted" style="margin-top:8px;">
      </div>
      <div id="active-escrow-milestones" class="tx-list" style="margin-top:12px;">
      </div>
    <div id="active-escrow-no-milestones" class="muted" style="margin-top:8px;display:none;">
      No milestones for this escrow.
    </div>
  </div>
</section>
<!-- Escrow History -->
<section id="s-history" class="screen">
  <h2>
    Escrow history
  </h2>
  <p class="lead">
    Completed and released escrows.
  </p>
  <div id="past-escrows-card" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>
        Past escrows
      </strong>
      <button class="ghost" data-action="navigate" data-target="s-create">
        Start new
      </button>
    </div>
    <div id="past-escrows-list" class="tx-list" style="margin-top:12px;">
    </div>
    <div id="past-escrows-empty" class="muted" style="margin-top:8px;">
      No past escrows yet.
    </div>
  </div>
</section>
  <!-- Dashboard -->
  <section id="s-dashboard" class="screen">
    <h2>
      Dashboard
    </h2>
    <p class="lead">
      Overview of your transactions and quick actions.
    </p>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>
          Transactions
        </strong>
      </div>
      <div id="dash-txlist" class="tx-list" style="margin-top:12px;">
      </div>
    </div>
  </section>
  <!-- Create -->
  <section id="s-create" class="screen">
    <h2>
      Create transaction
    </h2>
    <p class="lead">
      Set up an escrow between a buyer and seller.
    </p>
    <div class="card">
      <label class="muted">
        Your role
      </label>
      <div class="role-toggle" id="create-role-toggle">
        <label class="role-option">
          <input type="radio" name="create-role" value="buyer" checked>
          <span>
            I'm the buyer
          </span>
        </label>
        <label class="role-option">
          <input type="radio" name="create-role" value="seller">
          <span>
            I'm the seller
          </span>
        </label>
      </div>
      <div class="form-field">
        <label class="muted" id="counterparty-name-label">
          Seller name
        </label>
        <input id="counterparty-name" type="text" placeholder="Seller name" autocomplete="off">
      </div>
      <div class="form-field">
        <label class="muted" id="counterparty-email-label">
          Seller email
        </label>
        <input id="counterparty-email" type="email" placeholder="seller@example.com" autocomplete="email">
      </div>
      <div class="form-field">
        <label class="muted">
          Amount
        </label>
        <input id="create-amount" type="number" placeholder="Amount" inputmode="decimal">
      </div>
      <div class="form-field">
        <label class="muted">
          Category
        </label>
        <select id="create-category">
          <option>
            Goods
          </option>
          <option>
            Services
          </option>
          <option>
            Other
          </option>
        </select>
      </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="ghost" data-action="navigate" data-target="s-welcome">
        Cancel
      </button>
      <button class="btn" id="create-next">
        Next - Milestones
      </button>
    </div>
  </div>
  <div class="card" style="margin-top:16px;">
    <h3>
      Creation flows at a glance
    </h3>
    <p class="muted" style="margin:4px 0 0;">
      Share these timelines so both parties know exactly what happens next.
    </p>
    <div class="flow-grid">
      <div class="flow-block">
        <div class="flow-pill">
          Seller started escrow
        </div>
        <ol class="flow-steps">
          <li>Seller creates the escrow inside the app.</li>
          <li>An email alert goes to the buyer.</li>
          <li>Buyer signs in, lands on the dashboard, and sees <strong>Approval pending</strong>.</li>
          <li>Buyer opens the escrow from the dashboard or list view.</li>
          <li>Buyer reviews details and chooses <strong>Accept</strong> or <strong>Do not accept</strong>.</li>
          <li>After accepting, the buyer returns to the dashboard with a <strong>Funding pending</strong> card.</li>
          <li>The buyer clicks <strong>Click to fund</strong> to complete the setup.</li>
        </ol>
      </div>
      <div class="flow-block">
        <div class="flow-pill">
          Buyer started escrow
        </div>
        <ol class="flow-steps">
          <li>Buyer creates the escrow in the app.</li>
          <li>The seller receives an email invitation.</li>
          <li>Seller signs in and sees <strong>Approval pending</strong> on the dashboard.</li>
          <li>Seller opens the escrow tile from the dashboard or list.</li>
          <li>Seller reviews the agreement and chooses <strong>Accept</strong> or <strong>Do not accept</strong>.</li>
          <li>The buyer is immediately shown a <strong>Funding pending</strong> notification.</li>
          <li>Buyer finishes by selecting <strong>Click to fund</strong>.</li>
        </ol>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:12px;">
    <h3>
      How funds are released
    </h3>
    <p class="muted" style="margin:4px 0 0;">
      Milestones control the release so both sides confirm delivery.
    </p>
    <div class="flow-grid">
      <div class="flow-block">
        <div class="flow-pill">
          Milestone release
        </div>
        <ol class="flow-steps">
          <li>Seller opens an active escrow and submits the milestone for buyer review.</li>
          <li>The buyer receives an email and logs in to see <strong>Milestone pending</strong>.</li>
          <li>Buyer opens the escrow details from the alert.</li>
          <li>Buyer reviews the deliverable and approves the milestone.</li>
          <li>Funds immediately release to the seller&rsquo;s payout account.</li>
        </ol>
      </div>
    </div>
  </div>
</section>
  <!-- Milestones -->
  <section id="s-create-milestones" class="screen">
    <h2>
      Milestones
    </h2>
    <p class="lead">
      Break the agreement into deliverables before moving on to the terms.
    </p>
    <div class="card">
      <div class="muted">
        Milestone builder
      </div>
      <p class="muted" style="margin:4px 0 8px;font-size:13px;">
        Add payout checkpoints that should match your escrow amount.
      </p>
      <div id="milestone-form" class="milestone-form">
        <div class="form-field">
          <label class="muted" for="milestone-name">
            Milestone title
          </label>
          <input id="milestone-name" type="text" placeholder="Milestone title" autocomplete="off">
        </div>
        <div class="form-field">
          <label class="muted" for="milestone-amount">
            Amount
          </label>
          <input id="milestone-amount" type="number" placeholder="Amount" inputmode="decimal">
        </div>
        <button type="button" class="ghost" id="milestone-add">
          Add milestone
        </button>
      </div>
      <div id="milestone-empty" class="muted" style="margin-top:8px;">
        No milestones yet
      </div>
      <div id="milestone-list" class="tx-list" style="margin-top:8px;">
      </div>
      <div id="milestone-total" class="muted" style="margin-top:8px;display:none;text-align:right;">
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="ghost" data-action="navigate" data-target="s-create">
          Back
        </button>
        <button class="btn" id="milestones-next">
          Next - Terms
        </button>
      </div>
    </div>
  </section>
  <!-- Agreement & Signature -->
  <section id="s-agreement" class="screen">
    <h2>
      Agreement &amp; Signature
    </h2>
    <p class="lead">
      Review terms and sign to accept.
    </p>
    <div class="card">
      <label class="muted">
        Agreement (preview)
      </label>
      <textarea id="agreement-text" readonly style="height:120px">
        Standard escrow terms...
      </textarea>
      <div style="margin-top:12px;">
        <div class="muted">
          Milestones
        </div>
        <div id="agreement-milestones-empty" class="muted" style="margin-top:4px;">
          No milestones added
        </div>
        <div id="agreement-milestones" class="tx-list" style="margin-top:8px;">
        </div>
        <div id="agreement-milestones-total" class="muted" style="margin-top:8px;display:none;text-align:right;">
        </div>
      </div>
      <div style="margin-top:12px">
        <label class="muted">
          Sign below
        </label>
        <div class="sig-wrap" style="margin-top:8px;">
          <canvas id="signature-canvas" class="signature">
          </canvas>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center;">
          <button class="ghost" id="clear-sign">
            Clear
          </button>
          <div class="muted" style="margin-left:auto;">
            Draw with mouse or touch
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button class="ghost" data-action="navigate" data-target="s-create-milestones">
            Back
          </button>
          <button class="btn" id="agreement-next" disabled>
            Accept &amp; Continue
          </button>
        </div>
      </div>
    </div>
  </section>
  <!-- Funding -->
  <section id="s-funding" class="screen">
    <h2>
      Fund escrow
    </h2>
    <p class="lead">
      Add demo funds to your wallet.
    </p>
    <div class="card">
      <div class="muted">
        Amount
      </div>
      <div style="font-weight:800;font-size:18px">
        $
        <span id="fund-amount">
          0.00
        </span>
      </div>
      <label class="muted" style="margin-top:8px">
        Add to wallet
      </label>
      <input id="fund-input" type="number" placeholder="Amount to deposit" inputmode="decimal">
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="ghost" data-action="navigate" data-target="s-agreement">
          Back
        </button>
        <button class="btn" id="fund-confirm">
          Deposit &amp; Fund
        </button>
      </div>
    </div>
  </section>
  <!-- Transaction detail -->
  <section id="s-transaction" class="screen">
    <h2 id="tx-title">
      Transaction
    </h2>
    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
        <div>
          <div class="muted">
            Buyer
          </div>
          <div id="tx-buyer" style="font-weight:700">
          </div>
          <div class="muted" style="font-size:13px;margin-top:4px" id="tx-buyer-email">
          </div>
          <div class="muted" style="margin-top:8px">
            Seller
          </div>
          <div id="tx-seller" style="font-weight:700">
          </div>
          <div class="muted" style="font-size:13px;margin-top:4px" id="tx-seller-email">
          </div>
        </div>
        <div style="text-align:right">
          <div class="muted">
            Amount
          </div>
          <div id="tx-amount" style="font-weight:700">
          </div>
          <div id="tx-status" style="margin-top:8px">
          </div>
        </div>
      </div>
    </div>
    <div id="tx-milestones-card" class="card" style="margin-top:12px;display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <strong>
          Milestones
        </strong>
      </div>
      <div id="tx-milestones" class="tx-list" style="margin-top:12px;">
      </div>
    </div>
    <div id="tx-timeline" style="margin-top:12px">
    </div>
  </section>
  <!-- Wallet -->
  <section id="s-wallet" class="screen">
    <h2>
      Wallet
    </h2>
    <p class="lead">
      Demo wallet to fund/withdraw test transactions.
    </p>
    <div class="card">
      <div class="muted">
        Available balance
      </div>
      <div style="font-weight:800;font-size:18px">
        $
        <span id="wallet-balance">
          0.00
        </span>
      </div>
      <label class="muted" style="margin-top:8px">
        Top-up (mock)
      </label>
      <input id="wallet-topup" type="number" placeholder="Amount to deposit" inputmode="decimal">
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="wallet-deposit">
          Deposit
        </button>
        <button class="ghost" id="wallet-withdraw">
          Withdraw
        </button>
      </div>
      <h4 style="margin-top:16px;">
        History
      </h4>
      <div id="wallet-history" class="tx-list" style="margin-top:8px;">
      </div>
    </div>
  </section>
  <!-- Settings -->
  <section id="s-settings" class="screen">
    <h2>
      Settings
    </h2>
    <div class="card setting-card">
      <div class="settings-form">
        <label class="muted" for="profile-name">
          Full name
        </label>
        <input id="profile-name" type="text" placeholder="Your name" autocomplete="name">
        <label class="muted" for="profile-email">
          Email
        </label>
        <input id="profile-email" type="email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="settings-actions">
        <button class="ghost" id="mark-kyc">
          Mark KYC
        </button>
        <button class="btn" id="save-profile">
          Save
        </button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0;margin-bottom:6px;">
        Security
      </h3>
      <p class="muted" style="margin-top:0;margin-bottom:12px;">
        Update your password to keep your account protected.
      </p>
      <button class="btn" data-action="modal" data-content="<h3>
        Change password
      </h3>
      <p class='muted'>
        Enter your current password and choose a new one in the production app.
      </p>
      <button class='btn' style='width:100%;margin-top:8px;'>
        Continue
      </button>
      ">
        Change password
      </button>
    </div>
    <div class="card">
      <h3 style="margin-top:0;margin-bottom:6px;">
        Bank accounts
      </h3>
      <p class="muted" style="margin-top:0;margin-bottom:12px;">
        Add a payout account to receive escrow releases.
      </p>
      <button class="ghost" data-action="modal" data-content="<h3>
        Add bank account
      </h3>
      <p class='muted'>
        Provide your routing and account number to connect a bank in the full experience.
      </p>
      <button class='btn' style='width:100%;margin-top:8px;'>
        Link account
      </button>
      ">
        Add bank account
      </button>
    </div>
  </section>
</main>
<!-- Bottom toolbar -->
<div class="toolbar">
  <nav class="bottom-nav">
    <button data-action="navigate" data-target="s-dashboard" id="bn-dashboard" class="active" aria-label="Dashboard">
      .
    </button>
    <button data-action="navigate" data-target="s-create" id="bn-create" aria-label="Create">
      .
    </button>
    <button data-action="navigate" data-target="s-wallet" id="bn-wallet" aria-label="Wallet">
      .
    </button>
    <button data-action="navigate" data-target="s-settings" id="bn-settings" aria-label="Settings">
      .
    </button>
  </nav>
</div>
<!-- modal & toast -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:90;">
  <div id="modal-content">
  </div>
</div>
<div id="toast" style="display:none;position:fixed;right:16px;top:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:100;">
  msg
</div>
</div>
<!-- In-app browser hint (shown only when detected) -->
<button id="iab-open-safari" aria-label="Open in Safari">
  Open in Safari
</button>
<script>
(function(){
  var hash = window.location.hash || '';
  var params = {};
  if (hash) {
    var clean = hash.replace(/^#/, '');
    if (clean) {
      var pieces = clean.split('&');
      for (var i = 0; i < pieces.length; i++) {
        var part = pieces[i];
        if (!part) continue;
        var kv = part.split('=');
        var key = decodeURIComponent(kv[0] || '');
        if (!key) continue;
        var value = decodeURIComponent(kv[1] || '');
        if (!(key in params)) {
          params[key] = value;
        }
      }
    }
  }
  window.__initialParams = params;
})();
</script>
<!--PART 3 / 3 — SCRIPT (Safari-safe, all features wired)-->
<script>
(function () {
  function parseParams(source) {
    const result = {};
    if (!source) return result;
    const clean = source.replace(/^[?#]/, '');
    if (!clean) return result;
    clean.split('&').forEach(pair => {
      if (!pair) return;
      const parts = pair.split('=');
      const key = decodeURIComponent(parts[0] || '');
      if (!key) return;
      const value = decodeURIComponent(parts[1] || '');
      if (!(key in result)) {
        result[key] = value;
      }
    });
    return result;
  }

  const searchParams = parseParams(window.location.search);
  const hashParams = parseParams(window.location.hash);
  const externalParams = (typeof window.__initialParams === 'object' && window.__initialParams) || {};
  const shouldSkipSplash =
    Object.prototype.hasOwnProperty.call(searchParams, 'nosplash') ||
    Object.prototype.hasOwnProperty.call(hashParams, 'nosplash') ||
    Object.prototype.hasOwnProperty.call(externalParams, 'nosplash');

  const STORAGE_KEY = 'myescrow_mobilestable_v5';

  const INITIAL_STATE = {
    user: { name: 'Scott', email: 'scott@example.com' },
    wallet: {
      balance: 300,
      history: [
        { id: 'h1', type: 'deposit', amount: 250, date: new Date(Date.now() - 864e5 * 3).toISOString() },
        { id: 'h2', type: 'withdraw', amount: 50, date: new Date(Date.now() - 864e5 * 2).toISOString() },
        { id: 'h3', type: 'deposit', amount: 100, date: new Date(Date.now() - 864e5 * 1).toISOString() }
      ]
    },
    transactions: [
      {
        id: 10105,
        buyer: 'Scott',
        buyerEmail: 'scott@example.com',
        seller: 'Nora',
        sellerEmail: 'nora@example.com',
        amount: 650,
        status: 'pending',
        journeyStage: 'approval_pending',
        timeline: [
          { when: new Date(Date.now() - 3600 * 1000 * 6).toISOString(), text: 'Created by Scott (buyer)' },
          { when: new Date(Date.now() - 3600 * 1000 * 5.5).toISOString(), text: 'Seller Nora notified for approval' }
        ],
        milestones: [{ id: 'm10105a', title: 'Prototype delivery', amount: 650, status: 'pending' }]
      },
      {
        id: 10101,
        buyer: 'Scott',
        buyerEmail: 'scott@example.com',
        seller: 'Bob',
        sellerEmail: 'bob@example.com',
        amount: 500,
        status: 'pending',
        timeline: [{ when: new Date(Date.now() - 864e5 * 2).toISOString(), text: 'Created by Scott (buyer)' }],
        milestones: [
          { id: 'm10101a', title: 'Deposit received', amount: 250, status: 'pending' },
          { id: 'm10101b', title: 'Delivery inspection', amount: 250, status: 'pending' }
        ]
      },
      {
        id: 10102,
        buyer: 'John',
        buyerEmail: 'john@example.com',
        seller: 'Scott',
        sellerEmail: 'scott@example.com',
        amount: 1200,
        status: 'active',
        timeline: [
          { when: new Date(Date.now() - 864e5 * 4).toISOString(), text: 'Created by Scott (seller)' },
          { when: new Date(Date.now() - 864e5 * 1.5).toISOString(), text: 'Buyer funded escrow' },
          { when: new Date(Date.now() - 864e5 * 1).toISOString(), text: 'Milestone "Design draft" released' }
        ],
        milestones: [
          { id: 'm10102a', title: 'Design draft', amount: 400, status: 'released', releasedAt: new Date(Date.now() - 864e5 * 1).toISOString() },
          { id: 'm10102b', title: 'Development sprint', amount: 400, status: 'pending' },
          { id: 'm10102c', title: 'Final handoff', amount: 400, status: 'pending' }
        ]
      },
      {
        id: 10103,
        buyer: 'Scott',
        buyerEmail: 'scott@example.com',
        seller: 'Linda',
        sellerEmail: 'linda@example.com',
        amount: 300,
        status: 'resolved',
        timeline: [
          { when: new Date(Date.now() - 864e5 * 7).toISOString(), text: 'Created by Scott (buyer)' },
          { when: new Date(Date.now() - 864e5 * 5).toISOString(), text: 'Delivered' },
          { when: new Date(Date.now() - 864e5 * 4.5).toISOString(), text: 'Milestone "Prototype submitted" released' },
          { when: new Date(Date.now() - 864e5 * 4).toISOString(), text: 'Milestone "Client approval" released' },
          { when: new Date(Date.now() - 864e5 * 3.5).toISOString(), text: 'Closed' }
        ],
        milestones: [
          { id: 'm10103a', title: 'Prototype submitted', amount: 150, status: 'released', releasedAt: new Date(Date.now() - 864e5 * 4.5).toISOString() },
          { id: 'm10103b', title: 'Client approval', amount: 150, status: 'released', releasedAt: new Date(Date.now() - 864e5 * 4).toISOString() }
        ]
      },
      {
        id: 10104,
        buyer: 'Chris',
        buyerEmail: 'chris@example.com',
        seller: 'Scott',
        sellerEmail: 'scott@example.com',
        amount: 450,
        status: 'disputed',
        timeline: [
          { when: new Date(Date.now() - 864e5 * 1.2).toISOString(), text: 'Created by Scott (seller)' },
          { when: new Date(Date.now() - 864e5 * 0.5).toISOString(), text: 'Buyer disputed delivery' }
        ],
        milestones: [{ id: 'm10104a', title: 'Hardware delivered', amount: 450, status: 'pending' }]
      }
    ]
  };

  function cloneState(source) {
    return JSON.parse(JSON.stringify(source));
  }

  function formatStatus(text) {
    if (!text) return '';
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function formatMilestoneStatus(status) {
    if (status === 'released') return 'Released';
    return 'Pending release';
  }

  function formatCurrency(amount) {
    const value = Number(amount) || 0;
    return `$${value.toFixed(2)}`;
  }

  function sumMilestoneAmounts(list) {
    if (!Array.isArray(list)) return 0;
    return list.reduce((total, item) => total + (Number(item.amount) || 0), 0);
  }

  function milestoneTotalMatches(amount, total) {
    if (!Number.isFinite(amount)) return true;
    return Math.abs((Number(total) || 0) - Number(amount)) < 0.01;
  }

  function getUserIdentity() {
    return {
      name: state.user && state.user.name ? state.user.name : 'Scott',
      email: state.user && state.user.email ? state.user.email : 'scott@example.com'
    };
  }

  function isUserBuyer(tx) {
    if (!tx) return false;
    const user = getUserIdentity();
    const buyerEmailMatches =
      user.email && tx.buyerEmail && tx.buyerEmail.toLowerCase() === user.email.toLowerCase();
    if (buyerEmailMatches) return true;
    const sellerEmailMatches =
      user.email && tx.sellerEmail && tx.sellerEmail.toLowerCase() === user.email.toLowerCase();
    if (sellerEmailMatches) return false;
    if (tx.buyer === user.name) return true;
    if (tx.seller === user.name) return false;
    return true;
  }

  function getCounterpartyInfo(tx) {
    const userIsBuyer = isUserBuyer(tx);
    return {
      role: userIsBuyer ? 'seller' : 'buyer',
      name: userIsBuyer ? tx.seller : tx.buyer,
      email: userIsBuyer ? tx.sellerEmail : tx.buyerEmail
    };
  }

  function syncRoleToggle(role) {
    eachNode(document.querySelectorAll('.role-option'), label => {
      if (!label) return;
      const input = label.querySelector('input[name="create-role"]');
      const isMatch = input && input.value === role;
      if (input && isMatch && !input.checked) input.checked = true;
      label.classList.toggle('active', !!isMatch);
    });
  }

  function updateCounterpartyLabels(role) {
    const otherRole = role === 'seller' ? 'Buyer' : 'Seller';
    const nameLabel = document.getElementById('counterparty-name-label');
    const emailLabel = document.getElementById('counterparty-email-label');
    const nameInput = document.getElementById('counterparty-name');
    const emailInput = document.getElementById('counterparty-email');
    if (nameLabel) nameLabel.textContent = `${otherRole} name`;
    if (emailLabel) emailLabel.textContent = `${otherRole} email`;
    if (nameInput && !nameInput.placeholder) {
      nameInput.placeholder = `${otherRole} name`;
    } else if (nameInput) {
      nameInput.placeholder = `${otherRole} name`;
    }
    if (emailInput && !emailInput.placeholder) {
      emailInput.placeholder = `${otherRole.toLowerCase()}@example.com`;
    } else if (emailInput) {
      emailInput.placeholder = `${otherRole.toLowerCase()}@example.com`;
    }
    syncRoleToggle(role);
  }

  function eachNode(list, callback) {
    if (!list || typeof callback !== 'function') return;
    if (typeof list.forEach === 'function') {
      list.forEach(callback);
      return;
    }
    for (let i = 0; i < list.length; i += 1) {
      callback(list[i], i, list);
    }
  }

  let storage = null;
  let memoryStore = null;
  try {
    storage = window.localStorage;
    const probeKey = '__myescrow_probe__';
    storage.setItem(probeKey, probeKey);
    storage.removeItem(probeKey);
  } catch (error) {
    storage = null;
    console.warn('Persistent storage unavailable; falling back to in-memory state.', error);
  }

  let state = cloneState(INITIAL_STATE);
  let pendingCreate = {
    role: 'buyer',
    counterpartyName: 'Preview Seller',
    counterpartyEmail: 'seller@example.com',
    buyer: INITIAL_STATE.user.name,
    buyerEmail: INITIAL_STATE.user.email,
    seller: 'Preview Seller',
    sellerEmail: 'seller@example.com',
    amount: 650,
    milestones: []
  };
  let draftMilestones = [];
  let activeEscrowFocus = null;
  let sigCanvas = null;
  let sigCtx = null;
  let drawing = false;
  let signatureDrawn = false;

  function save() {
    try {
      if (storage) {
        storage.setItem(STORAGE_KEY, JSON.stringify(state));
      } else {
        memoryStore = cloneState(state);
      }
    } catch (error) {
      console.warn('localStorage unavailable', error);
      memoryStore = cloneState(state);
    }
    renderAll();
  }

  function load() {
    try {
      if (storage) {
        const raw = storage.getItem(STORAGE_KEY);
        state = raw ? JSON.parse(raw) : cloneState(INITIAL_STATE);
      } else {
        state = memoryStore ? cloneState(memoryStore) : cloneState(INITIAL_STATE);
      }
    } catch (error) {
      console.warn('Unable to load saved state. Resetting to defaults.', error);
      state = cloneState(INITIAL_STATE);
    }
  }

  function navigate(id) {
    eachNode(document.querySelectorAll('.screen'), screen => screen.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');

    eachNode(document.querySelectorAll('.bottom-nav button'), button => button.classList.remove('active'));
    const navButton = document.querySelector(`.bottom-nav button[data-target="${id}"]`);
    if (navButton) navButton.classList.add('active');
  }

  function renderDashboard() {
    const welcomeNameEl = document.getElementById('welcome-name');
    if (welcomeNameEl) welcomeNameEl.textContent = getUserIdentity().name;
    const list = document.getElementById('tx-list');
    const dash = document.getElementById('dash-txlist');
    if (!list || !dash) return;

    list.innerHTML = '';
    dash.innerHTML = '';

    if (!state.transactions.length) {
      const empty = '<div class="muted">No transactions</div>';
      list.innerHTML = empty;
      dash.innerHTML = empty;
      return;
    }

    state.transactions.slice(0, 3).forEach(tx => {
      const item = document.createElement('div');
      item.className = 'tx-item';
      const statusLabel = formatStatus(tx.status);
      item.innerHTML = `
        <div><strong>#${tx.id}</strong> ${tx.buyer} &rarr; ${tx.seller}</div>
        <div>${formatCurrency(tx.amount)} <span class="status-badge status-${tx.status}">${statusLabel}</span></div>
      `;
      item.style.cursor = 'pointer';
      item.addEventListener('click', () => viewTx(tx.id));
      list.appendChild(item);
    });

    state.transactions.forEach(tx => {
      const item = document.createElement('div');
      item.className = 'tx-item';
      const statusLabel = formatStatus(tx.status);
      item.innerHTML = `
        <div><strong>#${tx.id}</strong> ${tx.buyer} &rarr; ${tx.seller}</div>
        <div>${formatCurrency(tx.amount)} <span class="status-badge status-${tx.status}">${statusLabel}</span></div>
      `;
      item.addEventListener('click', () => viewTx(tx.id));
      dash.appendChild(item);
    });

    const recent = document.getElementById('ui-recent');
    if (recent) {
      const first = state.transactions[0];
      if (first) {
        const statusLabel = formatStatus(first.status);
        recent.textContent = `#${first.id} - ${statusLabel} (${formatCurrency(first.amount)})`;
      } else {
        recent.textContent = 'No activity yet';
      }
    }
  }

  function getPendingBuyerEscrow() {
    return state.transactions.find(tx => tx.status === 'pending' && isUserBuyer(tx));
  }

  function formatNotificationTime(isoValue) {
    if (!isoValue) return 'Just now';
    const date = new Date(isoValue);
    if (Number.isNaN(date.getTime())) return 'Just now';
    return date.toLocaleString();
  }

  function getNotifications() {
    const notifications = [];
    const pendingTx = getPendingBuyerEscrow();
    if (pendingTx) {
      notifications.push({
        id: `pending-${pendingTx.id}`,
        title: `Pending buyer escrow #${pendingTx.id}`,
        detail: `Waiting for ${pendingTx.seller} to accept before funding.`,
        meta: 'Just now',
        badge: 'Pending buyer escrow',
        action: () => viewTx(pendingTx.id)
      });
    }

    const resolvedTx = state.transactions.find(tx => tx.status === 'resolved');
    if (resolvedTx) {
      const lastTimeline =
        resolvedTx.timeline && resolvedTx.timeline.length
          ? resolvedTx.timeline[resolvedTx.timeline.length - 1]
          : null;
      notifications.push({
        id: `resolved-${resolvedTx.id}`,
        title: `Escrow #${resolvedTx.id} released`,
        detail: `${resolvedTx.seller} received funds for ${formatCurrency(resolvedTx.amount)}.`,
        meta: lastTimeline ? formatNotificationTime(lastTimeline.when) : 'Recently',
        badge: 'Release complete'
      });
    }

    const activeTx = state.transactions.find(tx => tx.status === 'active');
    if (activeTx) {
      notifications.push({
        id: `active-${activeTx.id}`,
        title: `Milestone update for #${activeTx.id}`,
        detail: `Next milestone "${activeTx.milestones && activeTx.milestones[0] ? activeTx.milestones[0].title : 'Milestone'}" is still awaiting confirmation.`,
        meta:
          activeTx.timeline && activeTx.timeline.length
            ? formatNotificationTime(activeTx.timeline[activeTx.timeline.length - 1].when)
            : 'Recently',
        badge: 'Milestone reminder'
      });
    }

    return notifications;
  }

  function openNotifications() {
    const notifications = getNotifications();
    if (!notifications.length) {
      showModal("<h3>Notifications</h3><p class='muted'>No notifications right now.</p>");
      return;
    }
    const listMarkup = notifications
      .map(notif => {
        return `
          <button class="notif-item" data-notif-id="${notif.id}" ${
          notif.action ? '' : 'data-disabled="true"'
        }>
            <div class="notif-title">
              ${notif.title}
              ${notif.badge ? `<span class="notif-badge">${notif.badge}</span>` : ''}
            </div>
            <div class="notif-detail">${notif.detail}</div>
            <div class="notif-meta">${notif.meta || 'Recently'}</div>
          </button>
        `;
      })
      .join('');

    showModal(`<h3>Notifications</h3><div class="notif-list">${listMarkup}</div>`);

    notifications.forEach(notif => {
      if (typeof notif.action !== 'function') return;
      const button = document.querySelector(`[data-notif-id="${notif.id}"]`);
      if (!button) return;
      button.addEventListener('click', () => {
        closeModal();
        notif.action();
      });
    });
  }

  function renderPendingEscrow() {
    const card = document.getElementById('home-pending-card');
    const notifBtn = document.getElementById('notifTop');
    const pill = document.getElementById('home-pending-pill');
    const title = document.getElementById('home-pending-title');
    const desc = document.getElementById('home-pending-desc');
    const stepsEl = document.getElementById('home-pending-steps');
    const viewBtn = document.getElementById('home-pending-view');
    const context = document.getElementById('home-pending-context');
    if (!card || !pill || !title || !desc || !stepsEl || !viewBtn || !context) return;

    const tx = getPendingBuyerEscrow();
    if (!tx) {
      card.style.display = 'none';
      if (notifBtn) notifBtn.removeAttribute('data-has-notif');
      return;
    }

    card.style.display = 'block';
    if (notifBtn) notifBtn.setAttribute('data-has-notif', 'true');
    const formattedAmount = formatCurrency(tx.amount);
    const sellerName = tx.seller || 'your counterparty';
    title.textContent = `Escrow #${tx.id} with ${tx.seller}`;
    desc.textContent = `You are the buyer on this ${formattedAmount} escrow and are waiting on ${sellerName} to move forward.`;
    const createdAt = tx.timeline && tx.timeline.length ? new Date(tx.timeline[0].when) : new Date();
    context.textContent = `Started ${createdAt.toLocaleDateString()}`;
    viewBtn.onclick = () => viewTx(tx.id);

    const stage = tx.journeyStage || 'approval_pending';
    const stageLabels = {
      approval_pending: 'Awaiting seller approval',
      funding_pending: 'Funding pending',
      milestone_pending: 'Milestone approval pending',
      released: 'Escrow released'
    };
    pill.textContent = stageLabels[stage] || 'Pending action';

    const steps = [
      {
        id: 'create',
        title: 'Buyer created escrow',
        detail: 'You drafted the agreement and notified the counterparty.',
        status: 'complete'
      },
      {
        id: 'approval',
        title: 'Approval pending',
        detail: `${sellerName} reviews the email invite and either accepts or declines.`,
        status: stage === 'approval_pending' ? 'active' : 'complete'
      },
      {
        id: 'funding',
        title: 'Funding pending',
        detail: 'Once approved, you tap “Click to fund” from the dashboard.',
        status:
          stage === 'funding_pending'
            ? 'active'
            : stage === 'approval_pending'
            ? 'upcoming'
            : 'complete'
      },
      {
        id: 'milestone',
        title: 'Milestone approval',
        detail: `You review deliverables and approve milestones to release funds after ${sellerName} submits them.`,
        status:
          stage === 'milestone_pending'
            ? 'active'
            : stage === 'released'
            ? 'complete'
            : 'upcoming'
      }
    ];

    stepsEl.innerHTML = '';
    steps.forEach(step => {
      const item = document.createElement('div');
      item.className = 'process-step';
      item.setAttribute('data-status', step.status);
      const statusCopy =
        step.status === 'complete' ? 'Done' : step.status === 'active' ? 'In progress' : 'Up next';
      item.innerHTML = `
        <div class="process-step-title">${step.title}</div>
        <div class="process-step-detail">${step.detail}</div>
        <div class="process-step-status">${statusCopy}</div>
      `;
      stepsEl.appendChild(item);
    });
  }

  function renderActiveEscrows() {
    const list = document.getElementById('active-escrows-list');
    const empty = document.getElementById('active-escrows-empty');
    const detailCard = document.getElementById('active-escrow-detail');
    if (!list || !empty || !detailCard) return;

    list.innerHTML = '';
    const active = state.transactions.filter(tx => tx.status === 'active');

    if (!active.length) {
      empty.style.display = 'block';
      detailCard.style.display = 'none';
      activeEscrowFocus = null;
      renderActiveEscrowDetail(null);
    } else {
      empty.style.display = 'none';

      if (!activeEscrowFocus || !active.some(tx => tx.id === activeEscrowFocus)) {
        activeEscrowFocus = active[0].id;
      }

      active.forEach(tx => {
        const item = document.createElement('div');
        item.className = 'tx-item';
        item.style.cursor = 'pointer';
        if (tx.id === activeEscrowFocus) item.classList.add('selected');
        const statusLabel = formatStatus(tx.status);
        const roleHint = isUserBuyer(tx) ? 'You are the buyer' : 'You are the seller';
        item.innerHTML = `
        <div><strong>#${tx.id}</strong> ${tx.buyer} &rarr; ${tx.seller}<div class="muted">${roleHint}</div></div>
        <div>${formatCurrency(tx.amount)} <span class="status-badge status-${tx.status}">${statusLabel}</span></div>
      `;
        item.addEventListener('click', () => selectActiveEscrow(tx.id));
        list.appendChild(item);
      });

      const selected = active.find(tx => tx.id === activeEscrowFocus) || null;
      renderActiveEscrowDetail(selected);
    }

    renderEscrowHistory();
  }

  function renderEscrowHistory() {
    const historyCard = document.getElementById('past-escrows-card');
    const list = document.getElementById('past-escrows-list');
    const empty = document.getElementById('past-escrows-empty');
    if (!historyCard || !list || !empty) return;

    list.innerHTML = '';
    const history = state.transactions.filter(
      tx => tx.status !== 'active' && tx.status !== 'pending'
    );

    if (!history.length) {
      empty.style.display = 'block';
      historyCard.style.display = 'block';
      return;
    }

    empty.style.display = 'none';
    historyCard.style.display = 'block';

    history.forEach(tx => {
      const item = document.createElement('div');
      item.className = 'tx-item';
      item.style.cursor = 'pointer';
      const statusLabel = formatStatus(tx.status);
      const roleHint = isUserBuyer(tx) ? 'You were the buyer' : 'You were the seller';
      item.innerHTML = `
        <div><strong>#${tx.id}</strong> ${tx.buyer} &rarr; ${tx.seller}<div class="muted">${roleHint}</div></div>
        <div>${formatCurrency(tx.amount)} <span class="status-badge status-${tx.status}">${statusLabel}</span></div>
      `;
      item.addEventListener('click', () => viewTx(tx.id));
      list.appendChild(item);
    });
  }

  function selectActiveEscrow(id) {
    if (activeEscrowFocus === id) return;
    activeEscrowFocus = id;
    renderActiveEscrows();
  }

  function renderActiveEscrowDetail(tx) {
    const detailCard = document.getElementById('active-escrow-detail');
    const meta = document.getElementById('active-escrow-meta');
    const progressEl = document.getElementById('active-escrow-progress');
    const milestonesEl = document.getElementById('active-escrow-milestones');
    const empty = document.getElementById('active-escrow-no-milestones');
    if (!detailCard || !meta || !progressEl || !milestonesEl || !empty) return;

    if (!tx) {
      detailCard.style.display = 'none';
      meta.innerHTML = '';
      milestonesEl.innerHTML = '';
      progressEl.textContent = '';
      return;
    }

    detailCard.style.display = 'block';
    meta.innerHTML = '';

    const metaLeft = document.createElement('div');
    const userIsBuyer = isUserBuyer(tx);
    const counterparty = getCounterpartyInfo(tx);
    const roleText = userIsBuyer ? 'You are the buyer' : 'You are the seller';
    const counterpartyText = counterparty.name
      ? `Counterparty: ${counterparty.name}${counterparty.email ? ` (${counterparty.email})` : ''}`
      : '';
    metaLeft.innerHTML = `<strong>#${tx.id}</strong> ${tx.buyer} &rarr; ${tx.seller}<div class="muted">${roleText}</div>${
      counterpartyText ? `<div class="muted">${counterpartyText}</div>` : ''
    }<div class="muted">Status: ${formatStatus(tx.status)}</div>`;

    const metaRight = document.createElement('div');
    metaRight.style.display = 'flex';
    metaRight.style.alignItems = 'center';
    metaRight.style.gap = '8px';

    const amountEl = document.createElement('div');
    amountEl.style.fontWeight = '700';
    amountEl.textContent = formatCurrency(tx.amount);

    const detailBtn = document.createElement('button');
    detailBtn.className = 'ghost';
    detailBtn.type = 'button';
    detailBtn.textContent = 'View full details';
    detailBtn.addEventListener('click', () => viewTx(tx.id));

    metaRight.appendChild(amountEl);
    metaRight.appendChild(detailBtn);

    meta.appendChild(metaLeft);
    meta.appendChild(metaRight);

    const milestones = Array.isArray(tx.milestones) ? tx.milestones : [];
    if (!milestones.length) {
      progressEl.textContent = 'No milestones defined.';
      milestonesEl.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';
    milestonesEl.innerHTML = '';

    const released = milestones.filter(milestone => milestone.status === 'released');
    const releasedTotal = released.reduce((sum, milestone) => sum + (Number(milestone.amount) || 0), 0);
    const totalAmount = milestones.reduce((sum, milestone) => sum + (Number(milestone.amount) || 0), 0);

    progressEl.textContent = `Released ${released.length}/${milestones.length} milestones (${formatCurrency(releasedTotal)} of ${formatCurrency(totalAmount)})`;
    if (!isUserBuyer(tx) && milestones.some(milestone => milestone.status !== 'released')) {
      progressEl.textContent += ' · Awaiting buyer release';
    }

    milestones.forEach((milestone, index) => {
      const item = document.createElement('div');
      item.className = 'tx-item';

      const left = document.createElement('div');
      const title = document.createElement('strong');
      title.textContent = `${index + 1}. ${milestone.title || 'Milestone'}`;
      const amountLine = document.createElement('div');
      amountLine.className = 'muted';
      amountLine.textContent = formatCurrency(milestone.amount);
      left.appendChild(title);
      left.appendChild(amountLine);
      if (milestone.status === 'released' && milestone.releasedAt) {
        const releasedLine = document.createElement('div');
        releasedLine.className = 'muted';
        releasedLine.textContent = `Released ${new Date(milestone.releasedAt).toLocaleString()}`;
        left.appendChild(releasedLine);
      }

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      right.style.gap = '8px';

      const badge = document.createElement('span');
      const badgeStatus = milestone.status === 'released' ? 'status-released' : 'status-pending';
      badge.className = `status-badge ${badgeStatus}`;
      badge.textContent = formatMilestoneStatus(milestone.status);
      right.appendChild(badge);

      if (tx.status === 'active' && milestone.status !== 'released' && isUserBuyer(tx)) {
        const action = document.createElement('button');
        action.className = 'btn';
        action.type = 'button';
        action.textContent = 'Release';
        action.addEventListener('click', () => acceptMilestone(tx.id, milestone.id));
        right.appendChild(action);
      }

      item.appendChild(left);
      item.appendChild(right);
      milestonesEl.appendChild(item);
    });
  }

  function renderMilestoneDrafts() {
    const list = document.getElementById('milestone-list');
    const empty = document.getElementById('milestone-empty');
    const total = document.getElementById('milestone-total');
    if (!list || !empty || !total) return;

    list.innerHTML = '';

    if (!draftMilestones.length) {
      empty.style.display = 'block';
      total.style.display = 'none';
      return;
    }

    empty.style.display = 'none';

    let sum = 0;
    draftMilestones.forEach(milestone => {
      const item = document.createElement('div');
      item.className = 'tx-item';

      const info = document.createElement('div');
      const title = document.createElement('strong');
      title.textContent = milestone.title;
      const amountMuted = document.createElement('div');
      amountMuted.className = 'muted';
      amountMuted.textContent = formatCurrency(milestone.amount);
      info.appendChild(title);
      info.appendChild(amountMuted);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'ghost';
      removeBtn.type = 'button';
      removeBtn.style.padding = '6px 10px';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => removeMilestone(milestone.id));

      item.appendChild(info);
      item.appendChild(removeBtn);
      list.appendChild(item);

      sum += Number(milestone.amount) || 0;
    });

    total.style.display = 'block';
    const amountInput = document.getElementById('create-amount');
    const enteredAmount = amountInput ? Number(amountInput.value) : NaN;
    if (Number.isFinite(enteredAmount)) {
      const matches = milestoneTotalMatches(enteredAmount, sum);
      const statusText = matches
        ? `Milestone total: ${formatCurrency(sum)} - Matches amount (${formatCurrency(enteredAmount)})`
        : `Milestone total: ${formatCurrency(sum)} - Needs to equal amount (${formatCurrency(enteredAmount)})`;
      total.textContent = statusText;
      total.classList.toggle('warning-text', !matches);
    } else {
      total.textContent = `Milestone total: ${formatCurrency(sum)}`;
      total.classList.remove('warning-text');
    }
  }

  function renderAgreementMilestones(milestones) {
    const list = document.getElementById('agreement-milestones');
    const empty = document.getElementById('agreement-milestones-empty');
    const total = document.getElementById('agreement-milestones-total');
    if (!list || !empty || !total) return;

    list.innerHTML = '';

    if (!milestones || !milestones.length) {
      empty.style.display = 'block';
      total.style.display = 'none';
      return;
    }

    empty.style.display = 'none';

    let sum = 0;
    milestones.forEach((milestone, index) => {
      const item = document.createElement('div');
      item.className = 'tx-item';

      const details = document.createElement('div');
      const title = document.createElement('strong');
      title.textContent = `${index + 1}. ${milestone.title}`;
      details.appendChild(title);

      const amountEl = document.createElement('div');
      amountEl.style.fontWeight = '600';
      amountEl.textContent = formatCurrency(milestone.amount);

      item.appendChild(details);
      item.appendChild(amountEl);
      list.appendChild(item);

      sum += Number(milestone.amount) || 0;
    });

    total.style.display = 'block';
    const referenceAmount =
      pendingCreate && Number.isFinite(Number(pendingCreate.amount)) ? Number(pendingCreate.amount) : NaN;
    if (Number.isFinite(referenceAmount)) {
      const matches = milestoneTotalMatches(referenceAmount, sum);
      const statusText = matches
        ? `Milestone total: ${formatCurrency(sum)} - Matches amount (${formatCurrency(referenceAmount)})`
        : `Milestone total: ${formatCurrency(sum)} - Needs to equal amount (${formatCurrency(referenceAmount)})`;
      total.textContent = statusText;
      total.classList.toggle('warning-text', !matches);
    } else {
      total.textContent = `Milestone total: ${formatCurrency(sum)}`;
      total.classList.remove('warning-text');
    }
  }

  function addMilestone() {
    const nameInput = document.getElementById('milestone-name');
    const amountInput = document.getElementById('milestone-amount');
    const title = nameInput ? nameInput.value.trim() : '';
    const amount = amountInput ? Number(amountInput.value) : NaN;

    if (!title || !isFinite(amount) || amount <= 0) {
      alert('Enter milestone title and amount');
      return;
    }

    const milestone = {
      id: generateMilestoneId(),
      title,
      amount
    };
    draftMilestones.push(milestone);
    renderMilestoneDrafts();
    renderAgreementMilestones(draftMilestones);
    if (nameInput) nameInput.value = '';
    if (amountInput) amountInput.value = '';
  }

  function removeMilestone(id) {
    draftMilestones = draftMilestones.filter(milestone => milestone.id !== id);
    renderMilestoneDrafts();
    renderAgreementMilestones(draftMilestones);
  }

  function generateMilestoneId() {
    return `m${Date.now()}${Math.floor(Math.random() * 1000)}`;
  }

  function acceptMilestone(txId, milestoneId) {
    const tx = state.transactions.find(entry => entry.id === txId);
    if (!tx || tx.status !== 'active') return;
    if (!isUserBuyer(tx)) {
      alert('Only the buyer can release milestones.');
      return;
    }

    const milestones = Array.isArray(tx.milestones) ? tx.milestones : [];
    const milestone = milestones.find(entry => entry.id === milestoneId);
    if (!milestone || milestone.status === 'released') return;

    const now = new Date().toISOString();
    const amount = Number(milestone.amount) || 0;

    milestone.status = 'released';
    milestone.releasedAt = now;

    if (!Array.isArray(tx.timeline)) {
      tx.timeline = [];
    }
    tx.timeline.push({ when: now, text: `Milestone "${milestone.title || milestone.id}" released` });

    const remaining = milestones.some(entry => entry.status !== 'released');
    if (!remaining) {
      tx.status = 'resolved';
      tx.timeline.push({ when: now, text: 'All milestones released. Escrow resolved.' });
      activeEscrowFocus = null;
    }

    if (amount > 0) {
      state.wallet.balance = Math.max(0, state.wallet.balance - amount);
      appendWalletHistory('withdraw', amount);
    }

    save();
  }

  function viewTx(id) {
    const tx = state.transactions.find(entry => entry.id === id);
    if (!tx) return;

    const titleEl = document.getElementById('tx-title');
    const buyerEl = document.getElementById('tx-buyer');
    const sellerEl = document.getElementById('tx-seller');
    const amountEl = document.getElementById('tx-amount');
    const statusEl = document.getElementById('tx-status');
    const timelineEl = document.getElementById('tx-timeline');
    const milestoneCard = document.getElementById('tx-milestones-card');
    const milestoneList = document.getElementById('tx-milestones');
    const buyerEmailEl = document.getElementById('tx-buyer-email');
    const sellerEmailEl = document.getElementById('tx-seller-email');

    const statusLabel = formatStatus(tx.status);

    if (titleEl) titleEl.textContent = `Transaction #${tx.id}`;
    if (buyerEl) buyerEl.textContent = tx.buyer;
    if (sellerEl) sellerEl.textContent = tx.seller;
    if (buyerEmailEl) buyerEmailEl.textContent = tx.buyerEmail || '';
    if (sellerEmailEl) sellerEmailEl.textContent = tx.sellerEmail || '';
    if (amountEl) amountEl.textContent = formatCurrency(tx.amount);
    if (statusEl) statusEl.innerHTML = `<span class="status-badge status-${tx.status}">${statusLabel}</span>`;
    if (timelineEl) {
      timelineEl.innerHTML = tx.timeline
        .map(event => `<div class="muted">${new Date(event.when).toLocaleString()} - ${event.text}</div>`)
        .join('');
    }
    if (milestoneCard && milestoneList) {
      milestoneList.innerHTML = '';
      const milestones = Array.isArray(tx.milestones) ? tx.milestones : [];
      if (!milestones.length) {
        milestoneCard.style.display = 'none';
      } else {
        milestoneCard.style.display = 'block';
        milestones.forEach((milestone, index) => {
          const item = document.createElement('div');
          item.className = 'tx-item';

          const left = document.createElement('div');
          const title = document.createElement('strong');
          title.textContent = `${index + 1}. ${milestone.title || 'Milestone'}`;
          const amountLine = document.createElement('div');
          amountLine.className = 'muted';
          amountLine.textContent = formatCurrency(milestone.amount);
          left.appendChild(title);
          left.appendChild(amountLine);
          if (milestone.status === 'released' && milestone.releasedAt) {
            const releasedLine = document.createElement('div');
            releasedLine.className = 'muted';
            releasedLine.textContent = `Released ${new Date(milestone.releasedAt).toLocaleString()}`;
            left.appendChild(releasedLine);
          }

          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.alignItems = 'center';
          right.style.gap = '8px';

          const badge = document.createElement('span');
          const badgeStatus = milestone.status === 'released' ? 'status-released' : 'status-pending';
          badge.className = `status-badge ${badgeStatus}`;
          badge.textContent = formatMilestoneStatus(milestone.status);
          right.appendChild(badge);

          item.appendChild(left);
          item.appendChild(right);
          milestoneList.appendChild(item);
        });
      }
    }

    state._activeTx = id;
    navigate('s-transaction');
  }

  function renderWallet() {
    const balanceEl = document.getElementById('wallet-balance');
    const homeBalanceEl = document.getElementById('ui-balance');
    if (balanceEl) balanceEl.textContent = state.wallet.balance.toFixed(2);
    if (homeBalanceEl) homeBalanceEl.textContent = state.wallet.balance.toFixed(2);

    const historyEl = document.getElementById('wallet-history');
    if (!historyEl) return;
    historyEl.innerHTML = '';

    if (!state.wallet.history.length) {
      historyEl.innerHTML = '<div class="muted">No wallet activity</div>';
      return;
    }

    state.wallet.history.slice().reverse().forEach(entry => {
      const item = document.createElement('div');
      item.className = 'tx-item';
      const color = entry.type === 'deposit' ? '#16a34a' : '#dc2626';
      const sign = entry.type === 'deposit' ? '+' : '-';
      item.innerHTML = `
        <div>${new Date(entry.date).toLocaleString()} - ${formatStatus(entry.type)}</div>
        <div style="color:${color};font-weight:600;">${sign}${formatCurrency(entry.amount)}</div>
      `;
      historyEl.appendChild(item);
    });
  }

  function appendWalletHistory(type, amount) {
    const entryId = `h${Date.now()}${Math.floor(Math.random() * 1000)}`;
    state.wallet.history.push({
      id: entryId,
      type,
      amount,
      date: new Date().toISOString()
    });
  }

  function renderAll() {
    renderDashboard();
    renderPendingEscrow();
    renderActiveEscrows();
    renderMilestoneDrafts();
    const agreementMilestones =
      pendingCreate && Array.isArray(pendingCreate.milestones) ? pendingCreate.milestones : draftMilestones;
    renderAgreementMilestones(agreementMilestones);
    renderWallet();
    const selectedRoleInput = document.querySelector('input[name="create-role"]:checked');
    updateCounterpartyLabels(selectedRoleInput ? selectedRoleInput.value : 'buyer');
  }

  function getCreateFormValues() {
    const roleInput = document.querySelector('input[name="create-role"]:checked');
    const role = roleInput ? roleInput.value : 'buyer';
    const counterpartyNameInput = document.getElementById('counterparty-name');
    const counterpartyEmailInput = document.getElementById('counterparty-email');
    const amountInput = document.getElementById('create-amount');
    const counterpartyName = counterpartyNameInput ? counterpartyNameInput.value.trim() : '';
    const counterpartyEmail = counterpartyEmailInput ? counterpartyEmailInput.value.trim() : '';
    const amount = amountInput ? Number(amountInput.value) : NaN;
    return { role, counterpartyName, counterpartyEmail, amount };
  }

  function validateCreateBasics() {
    const basics = getCreateFormValues();
    if (!basics.counterpartyName || !basics.counterpartyEmail || !isFinite(basics.amount) || basics.amount <= 0) {
      alert('Fill counterparty name, email, and amount');
      return null;
    }
    return basics;
  }

  function goToMilestoneBuilder() {
    const basics = validateCreateBasics();
    if (!basics) return;
    renderMilestoneDrafts();
    navigate('s-create-milestones');
  }

  function startAgreement() {
    const basics = validateCreateBasics();
    if (!basics) return;
    const { role, counterpartyName, counterpartyEmail, amount } = basics;

    const user = getUserIdentity();

    const milestones = draftMilestones.map(item => ({
      id: item.id,
      title: item.title,
      amount: Number(item.amount) || 0,
      status: 'pending'
    }));

    const milestoneSum = sumMilestoneAmounts(milestones);
    if (milestones.length && !milestoneTotalMatches(amount, milestoneSum)) {
      alert(
        `Milestone total (${formatCurrency(milestoneSum)}) must equal the Amount (${formatCurrency(amount)}). Adjust your milestones before continuing.`
      );
      return;
    }

    const buyer = role === 'buyer' ? user.name : counterpartyName;
    const buyerEmail = role === 'buyer' ? user.email : counterpartyEmail;
    const seller = role === 'buyer' ? counterpartyName : user.name;
    const sellerEmail = role === 'buyer' ? counterpartyEmail : user.email;

    pendingCreate = {
      role,
      counterpartyName,
      counterpartyEmail,
      buyer,
      buyerEmail,
      seller,
      sellerEmail,
      amount,
      milestones
    };

    const agreementText = document.getElementById('agreement-text');
    if (agreementText) {
      let preview = `Buyer: ${buyer} (${buyerEmail})\nSeller: ${seller} (${sellerEmail})\nAmount: ${formatCurrency(
        amount
      )}`;
      if (milestones.length) {
        preview += '\n\nMilestones:\n';
        preview += milestones
          .map((milestone, index) => `${index + 1}. ${milestone.title} - ${formatCurrency(milestone.amount)}`)
          .join('\n');
      }
      agreementText.value = preview;
    }
    renderAgreementMilestones(milestones);

    navigate('s-agreement');
    initSignature();
  }

  function initSignature() {
    sigCanvas = document.getElementById('signature-canvas');
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = 'round';

    const resizeSignatureCanvas = () => {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = sigCanvas.getBoundingClientRect();
      sigCanvas.width = Math.floor(rect.width * ratio);
      sigCanvas.height = Math.floor(rect.height * ratio);
      sigCtx.setTransform(ratio, 0, 0, ratio, 0, 0);
    };

    resizeSignatureCanvas();
    window.addEventListener('resize', resizeSignatureCanvas, { passive: true });

    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    signatureDrawn = false;
    const nextButton = document.getElementById('agreement-next');
    if (nextButton) nextButton.disabled = true;

    sigCanvas.onmousedown = event => {
      drawing = true;
      sigCtx.beginPath();
      sigCtx.moveTo(event.offsetX, event.offsetY);
    };

    sigCanvas.onmousemove = event => {
      if (!drawing) return;
      sigCtx.lineTo(event.offsetX, event.offsetY);
      sigCtx.stroke();
      signatureDrawn = true;
      if (nextButton) nextButton.disabled = false;
    };

    sigCanvas.onmouseup = () => {
      drawing = false;
    };

    sigCanvas.addEventListener('touchstart', event => {
      event.preventDefault();
      const touch = event.touches[0];
      const rect = sigCanvas.getBoundingClientRect();
      drawing = true;
      sigCtx.beginPath();
      sigCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    }, { passive: false });

    sigCanvas.addEventListener('touchmove', event => {
      event.preventDefault();
      if (!drawing) return;
      const touch = event.touches[0];
      const rect = sigCanvas.getBoundingClientRect();
      sigCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      sigCtx.stroke();
      signatureDrawn = true;
      if (nextButton) nextButton.disabled = false;
    }, { passive: false });

    sigCanvas.addEventListener('touchend', () => {
      drawing = false;
    }, { passive: false });
  }

  function ensurePendingDefaults(updateUI) {
    const user = getUserIdentity();
    if (!pendingCreate) {
      pendingCreate = {
        role: 'buyer',
        counterpartyName: '',
        counterpartyEmail: '',
        buyer: user.name,
        buyerEmail: user.email,
        seller: '',
        sellerEmail: '',
        amount: 0,
        milestones: []
      };
    }
    if (!pendingCreate.role) {
      const inferredRole =
        pendingCreate.buyer === user.name || pendingCreate.buyerEmail === user.email ? 'buyer' : 'seller';
      pendingCreate.role = inferredRole || 'buyer';
    }
    if (!pendingCreate.buyer) {
      pendingCreate.buyer = pendingCreate.role === 'buyer' ? user.name : pendingCreate.counterpartyName || '';
    }
    if (!pendingCreate.buyerEmail) {
      pendingCreate.buyerEmail = pendingCreate.role === 'buyer' ? user.email : pendingCreate.counterpartyEmail || '';
    }
    if (!pendingCreate.seller) {
      pendingCreate.seller = pendingCreate.role === 'buyer' ? pendingCreate.counterpartyName || '' : user.name;
    }
    if (!pendingCreate.sellerEmail) {
      pendingCreate.sellerEmail =
        pendingCreate.role === 'buyer' ? pendingCreate.counterpartyEmail || '' : user.email;
    }
    if (!pendingCreate.counterpartyName) {
      pendingCreate.counterpartyName =
        pendingCreate.role === 'buyer' ? pendingCreate.seller : pendingCreate.buyer;
    }
    if (!pendingCreate.counterpartyEmail) {
      pendingCreate.counterpartyEmail =
        pendingCreate.role === 'buyer' ? pendingCreate.sellerEmail : pendingCreate.buyerEmail;
    }
    const normalizedMilestones = Array.isArray(pendingCreate.milestones)
      ? pendingCreate.milestones.map((item, index) => {
          const normalized = {
            id: item && item.id ? item.id : generateMilestoneId(),
            title: item && item.title ? item.title : `Milestone ${index + 1}`,
            amount: Number(item && item.amount) || 0,
            status: item && item.status === 'released' ? 'released' : 'pending'
          };
          if (item && item.status === 'released' && item.releasedAt) {
            normalized.releasedAt = item.releasedAt;
          }
          return normalized;
        })
      : [];
    pendingCreate.milestones = normalizedMilestones.map(item => ({ ...item }));
    draftMilestones = normalizedMilestones.map(item => ({ ...item }));
    if (updateUI) {
      const amountInput = document.getElementById('create-amount');
      if (amountInput) amountInput.value = isFinite(pendingCreate.amount) ? pendingCreate.amount : '';
      const counterpartyNameInput = document.getElementById('counterparty-name');
      if (counterpartyNameInput) counterpartyNameInput.value = pendingCreate.counterpartyName || '';
      const counterpartyEmailInput = document.getElementById('counterparty-email');
      if (counterpartyEmailInput) counterpartyEmailInput.value = pendingCreate.counterpartyEmail || '';
      updateCounterpartyLabels(pendingCreate.role || 'buyer');
      const agreementText = document.getElementById('agreement-text');
      if (agreementText) {
        let preview = `Buyer: ${pendingCreate.buyer} (${pendingCreate.buyerEmail || 'n/a'})\nSeller: ${
          pendingCreate.seller
        } (${pendingCreate.sellerEmail || 'n/a'})\nAmount: ${formatCurrency(pendingCreate.amount || 0)}`;
        if (pendingCreate.milestones.length) {
          preview += '\n\nMilestones:\n';
          preview += pendingCreate.milestones
            .map((milestone, index) => `${index + 1}. ${milestone.title} - ${formatCurrency(milestone.amount)}`)
            .join('\n');
        }
        agreementText.value = preview;
      }
      const fundAmount = document.getElementById('fund-amount');
      if (fundAmount) {
        const value = Number(pendingCreate.amount);
        fundAmount.textContent = isFinite(value) ? value.toFixed(2) : '0.00';
      }
      renderMilestoneDrafts();
      renderAgreementMilestones(pendingCreate.milestones);
    }
  }

  function clearSignature() {
    if (sigCtx && sigCanvas) {
      sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
      signatureDrawn = false;
      const nextButton = document.getElementById('agreement-next');
      if (nextButton) nextButton.disabled = true;
    }
  }

  function toFunding() {
    if (!signatureDrawn || !pendingCreate) {
      alert('Sign first');
      return;
    }
    ensurePendingDefaults(true);
    navigate('s-funding');
  }

  function depositMock() {
    const input = document.getElementById('fund-input');
    const value = input ? Number(input.value) : NaN;
    if (!isFinite(value) || value <= 0) {
      alert('Enter valid amount');
      return;
    }
    state.wallet.balance += value;
    appendWalletHistory('deposit', value);

    if (pendingCreate) {
      const newId = Math.floor(10000 + Math.random() * 90000);
      const now = new Date().toISOString();
      const user = getUserIdentity();
      const role = pendingCreate.role || 'buyer';
      const creationTimeline = [
        { when: now, text: `Created by ${user.name} (${role})` },
        {
          when: now,
          text: role === 'buyer' ? 'Buyer funded escrow' : 'Seller recorded buyer funding'
        }
      ];
      state.transactions.unshift({
        id: newId,
        buyer: pendingCreate.buyer,
        buyerEmail: pendingCreate.buyerEmail,
        seller: pendingCreate.seller,
        sellerEmail: pendingCreate.sellerEmail,
        amount: pendingCreate.amount,
        milestones: pendingCreate.milestones ? pendingCreate.milestones.map(item => ({ ...item })) : [],
        status: 'active',
        timeline: creationTimeline
      });
      activeEscrowFocus = newId;
      pendingCreate = null;
      draftMilestones = [];
      const amountInput = document.getElementById('create-amount');
      if (amountInput) amountInput.value = '';
      const counterpartyName = document.getElementById('counterparty-name');
      if (counterpartyName) counterpartyName.value = '';
      const counterpartyEmail = document.getElementById('counterparty-email');
      if (counterpartyEmail) counterpartyEmail.value = '';
      const milestoneName = document.getElementById('milestone-name');
      if (milestoneName) milestoneName.value = '';
      const milestoneAmount = document.getElementById('milestone-amount');
      if (milestoneAmount) milestoneAmount.value = '';
      const roleBuyerInput = document.querySelector('input[name="create-role"][value="buyer"]');
      if (roleBuyerInput) roleBuyerInput.checked = true;
      updateCounterpartyLabels('buyer');
    }

    save();
    navigate('s-dashboard');
  }

  function depositWallet() {
    const input = document.getElementById('wallet-topup');
    const value = input ? Number(input.value) : NaN;
    if (!isFinite(value) || value <= 0) {
      alert('Enter valid amount');
      return;
    }
    state.wallet.balance += value;
    appendWalletHistory('deposit', value);
    if (input) input.value = '';
    save();
  }

  function withdrawWallet() {
    const response = prompt('Withdraw amount');
    const value = Number(response);
    if (!isFinite(value) || value <= 0 || value > state.wallet.balance) {
      alert('Invalid withdrawal');
      return;
    }
    state.wallet.balance -= value;
    appendWalletHistory('withdraw', value);
    save();
  }

  function showModal(html) {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');
    if (!modal || !modalContent) return;
    const body = html || '';
    modalContent.innerHTML = `
      <div style="background:#fff; padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.15); max-width:90vw;">
        ${body}
        <div style="text-align:right; margin-top:12px;">
          <button class="ghost" onclick="closeModal()">Close</button>
        </div>
      </div>
    `;
    modal.style.display = 'flex';
    modal.scrollTop = 0;
  }

  function closeModal() {
    const modal = document.getElementById('modal');
    if (modal) modal.style.display = 'none';
  }

  window.closeModal = closeModal;

  function init() {
    load();
    renderAll();

    const createNext = document.getElementById('create-next');
    if (createNext) createNext.addEventListener('click', goToMilestoneBuilder);

    const milestonesNext = document.getElementById('milestones-next');
    if (milestonesNext) milestonesNext.addEventListener('click', startAgreement);

    const agreementNext = document.getElementById('agreement-next');
    if (agreementNext) agreementNext.addEventListener('click', toFunding);

    const clearSign = document.getElementById('clear-sign');
    if (clearSign) clearSign.addEventListener('click', clearSignature);

    const fundConfirm = document.getElementById('fund-confirm');
    if (fundConfirm) fundConfirm.addEventListener('click', depositMock);

    const walletDeposit = document.getElementById('wallet-deposit');
    if (walletDeposit) walletDeposit.addEventListener('click', depositWallet);

    const walletWithdraw = document.getElementById('wallet-withdraw');
    if (walletWithdraw) walletWithdraw.addEventListener('click', withdrawWallet);

    const milestoneAdd = document.getElementById('milestone-add');
    if (milestoneAdd) milestoneAdd.addEventListener('click', addMilestone);
    const milestoneAmountInput = document.getElementById('milestone-amount');
    if (milestoneAmountInput) {
      milestoneAmountInput.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addMilestone();
        }
      });
    }
    const createAmountInput = document.getElementById('create-amount');
    if (createAmountInput) {
      createAmountInput.addEventListener('input', () => {
        const value = Number(createAmountInput.value);
        ensurePendingDefaults(false);
        if (pendingCreate) {
          pendingCreate.amount = Number.isFinite(value) ? value : 0;
        }
        renderMilestoneDrafts();
        renderAgreementMilestones(draftMilestones);
      });
    }
    eachNode(document.querySelectorAll('input[name="create-role"]'), input => {
      if (!input) return;
      input.addEventListener('change', () => {
        const value = input.value || 'buyer';
        ensurePendingDefaults(false);
        pendingCreate.role = value;
        const nameInput = document.getElementById('counterparty-name');
        const emailInput = document.getElementById('counterparty-email');
        if (nameInput) pendingCreate.counterpartyName = nameInput.value.trim();
        if (emailInput) pendingCreate.counterpartyEmail = emailInput.value.trim();
        const user = getUserIdentity();
        if (value === 'buyer') {
          pendingCreate.buyer = user.name;
          pendingCreate.buyerEmail = user.email;
          pendingCreate.seller = pendingCreate.counterpartyName || '';
          pendingCreate.sellerEmail = pendingCreate.counterpartyEmail || '';
        } else {
          pendingCreate.seller = user.name;
          pendingCreate.sellerEmail = user.email;
          pendingCreate.buyer = pendingCreate.counterpartyName || '';
          pendingCreate.buyerEmail = pendingCreate.counterpartyEmail || '';
        }
        updateCounterpartyLabels(value);
      });
    });

    const brand = document.getElementById('brand');
    if (brand) brand.addEventListener('click', () => navigate('s-welcome'));

    const homeTop = document.getElementById('homeTop');
    if (homeTop) homeTop.addEventListener('click', () => navigate('s-welcome'));

    const notifTop = document.getElementById('notifTop');
    if (notifTop) notifTop.addEventListener('click', openNotifications);

    const profileTop = document.getElementById('profileTop');
    if (profileTop) profileTop.addEventListener('click', () => navigate('s-settings'));

    eachNode(document.querySelectorAll('[data-action="navigate"]'), el => {
      el.addEventListener('click', () => {
        const target = el.getAttribute('data-target');
        if (target) navigate(target);
      });
    });

    eachNode(document.querySelectorAll('[data-action="modal"]'), el => {
      el.addEventListener('click', () => {
        const html = el.getAttribute('data-content') || '';
        showModal(html);
      });
    });

    eachNode(document.querySelectorAll('.bottom-nav button'), btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        if (target) navigate(target);
      });
    });

    const safariHint = document.getElementById('iab-open-safari');
    if (safariHint) {
      const ua = navigator.userAgent || '';
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isQuickLook = /QuickLook/i.test(ua);
      const embeddedApp = /(FBAN|FBAV|FB_IAB|Instagram|Twitter|Line|WhatsApp|wv)/i.test(ua);
      const standaloneBrowser = /Safari|CriOS|FxiOS/i.test(ua) && !embeddedApp;
      const inApp = isQuickLook || (embeddedApp && !standaloneBrowser);
      if (isIOS && inApp) {
        safariHint.style.display = 'inline-flex';
        safariHint.addEventListener('click', () => {
          showModal("<h3>Open in Safari</h3><p class='muted'>In your app, tap the share icon and choose <strong>Open in Safari</strong>.</p>");
        });
      }
    }

    const screenParam = searchParams.screen || hashParams.screen || externalParams.screen || null;
    const txParam = searchParams.tx || hashParams.tx || externalParams.tx || null;
    if (screenParam === 's-agreement' || screenParam === 's-funding') {
      ensurePendingDefaults(true);
    }

    if (screenParam === 's-transaction' && txParam) {
      viewTx(Number(txParam));
    } else if (screenParam) {
      navigate(screenParam);
    }

    if (txParam && screenParam !== 's-transaction') {
      viewTx(Number(txParam));
    }
  }

  window._demoNavigate = navigate;
  window._demoEnsurePending = ensurePendingDefaults;
  window._demoViewTx = viewTx;

  function showApp() {
    const app = document.getElementById('app');
    const splash = document.getElementById('splash');
    if (!app) return;
    app.classList.add('visible');
    app.style.display = 'grid';
    app.style.visibility = 'visible';
    void app.offsetHeight;
    if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
    window.scrollTo(0, 0);
  }

  document.addEventListener('DOMContentLoaded', () => {
    init();
    const splash = document.getElementById('splash');
    if (shouldSkipSplash) {
      if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
      showApp();
      return;
    }
    if (splash) {
      splash.addEventListener('animationend', showApp, { once: true });
      setTimeout(showApp, 2800);
    } else {
      showApp();
    }
  });

  window.addEventListener('pageshow', event => {
    if (event.persisted || !document.getElementById('splash')) {
      showApp();
    }
  });

  window.addEventListener('load', () => {
    if (shouldSkipSplash || !document.getElementById('splash')) {
      setTimeout(showApp, 1500);
    }
  });
})();
</script>
</body>
</html>


